services:
  annotation-tool3:
    build:
      context: ..
      dockerfile: Docker/Dockerfile
    container_name: ink_annotation_tool3
    # user: "50157:1000"  # Temporarily commented out to allow root access for cleanup
    ports:
      - "10707:10707"  # ✓ Changed both host and container ports
      - "10708:10708"  # ✓ Changed both host and container ports
    volumes:
      # Mount parent directories containing all the datasets
      - /local/data/magicscan/dzi_ink_datasets/HnE/BRACS:/data/dzi_datasets/BRACS:ro
      - /local/data/magicscan/dzi_ink_datasets/HnE/TCGA-BRCA:/data/dzi_datasets/TCGA:ro
      - /local/data/magicscan/dzi_ink_datasets/HnE/BACH:/data/dzi_datasets/BACH:ro
      
      # Annotations directory
      - /local/data/magicscan/ink_output/user3:/data/anno
      
      # Ink status
      - /local/data/magicscan/ink_output/user3/ink_status:/data/ink_status
      
      
      # Mount the JSON mapping file
      - ./tiles_directory_list_part_3.json:/data/tiles_directory_list.json:ro
    environment:
      - PYTHONUNBUFFERED=1
      - PANEL_APP_PORT=10707  # ✓ Different port
      - DZI_SERVER_PORT=10708  # ✓ Different port
      - UMASK=0000
    env_file:
      - ../app/.env
    restart: unless-stopped
    networks:
      - ink_annotation_network3

  redis3:
    image: redis:7-alpine
    container_name: ink_annotation_redis3
    ports:
      - "10709:6379"
    volumes:
      - redis_data3:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    networks:
      - ink_annotation_network3
volumes:
  redis_data3:

networks:
  ink_annotation_network3:

